name: Push to S3.

on:
  push:
    branches:
      - main

jobs:
  handle:
    runs-on: ubuntu-latest
    permissions:
        id-token: write    # Required for OIDC
        contents: read     # Required to checkout the code
    steps:
      - name: Checkout metadata repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::323258005321:role/kans-gontzess-metadata-bucket-tester
          aws-region: us-west-2

      - name: Get changed files (with status)
        id: changes
        run: |
          git diff --name-status HEAD^ HEAD -- ./bucket/ > changed_files.txt
          cat changed_files.txt

      - name: Sync changes to S3 (with logging)
        run: |
            uploaded_files=()
            deleted_files=()
  
            while IFS=$'\t' read -r status path; do
              if [[ "$path" == bucket/index.json || "$path" == bucket/metadata/* ]]; then
                s3_key="${path#bucket/}"
                case "$status" in
                  added|modified)
                    if [[ -f "$path" ]]; then
                      echo "Uploading $path to s3://kans-gontzess-metadata-test-bucket/$s3_key"
                      aws s3 cp "$path" "s3://kans-gontzess-metadata-test-bucket/$s3_key"
                      uploaded_files+=("$s3_key")
                    fi
                    ;;
                  removed)
                    echo "Deleting s3://kans-gontzess-metadata-test-bucket/$s3_key"
                    aws s3 rm "s3://kans-gontzess-metadata-test-bucket/$s3_key"
                    deleted_files+=("$s3_key")
                    ;;
                esac
              fi
            done <<< "$(cat changed_files.txt)"
  
            echo ""
            echo "==== Summary ===="
            echo "Uploaded:"
            for f in "${uploaded_files[@]}"; do echo "  - $f"; done
  
            echo "Deleted:"
            for f in "${deleted_files[@]}"; do echo "  - $f"; done